name: Deploy to IONOS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to IONOS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            cd /kunden/homepages/39/d4299589649/htdocs

            # Deploy frontend
            cat > index.html << 'HTML'
            <!DOCTYPE html>
            <html lang="en">
            <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>RPP AUTO - Recession Proof Products</title>
            <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            }
            .container { text-align: center; padding: 2rem; max-width: 600px; }
            .logo { font-size: 4rem; margin-bottom: 1rem; }
            h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 700; }
            p { font-size: 1.2rem; opacity: 0.9; margin-bottom: 2rem; }
            .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            }
            @keyframes spin { to { transform: rotate(360deg); } }
            .status {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 10px;
            display: inline-block;
            margin-top: 2rem;
            }
            .api-link { color: white; text-decoration: none; border-bottom: 2px solid white; }
            </style>
            </head>
            <body>
            <div class="container">
            <div class="logo">ðŸš—</div>
            <h1>RPP AUTO</h1>
            <p>Recession Proof Products - Your Automotive SaaS Platform</p>
            <div class="spinner"></div>
            <p>Platform Loading...</p>
            <div class="status">
            âœ… API: <a href="/api/health" class="api-link">Check Status</a>
            </div>
            </div>
            </body>
            </html>
            HTML

            # Setup SSH keys for GitHub Actions
            mkdir -p ~/.ssh && chmod 700 ~/.ssh
            touch ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys
            echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGmQ/Pdc6vzahBta5bdtZAjBjBB538ZoxfXe561lrMAE github-actions@rpp-auto" >> ~/.ssh/authorized_keys

            # Clone/update repository
            mkdir -p RPP_AUTO && cd RPP_AUTO
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/Owwmann/RPP-AUTO-FullStack.git
              git fetch origin
              git checkout -b main origin/main
            else
              git pull origin main
            fi

            # Setup backend
            cd rpp-auto-backend
            [ ! -d "venv" ] && python3 -m venv venv
            source venv/bin/activate
            pip install -q --upgrade pip
            pip install -q -r requirements.txt

            # Create production environment file
            cat > production.env << 'ENV'
            ENVIRONMENT=production
            DATABASE_URL=postgresql://postgres:Brotherbey765%40%40@db.gfhthbmbgoxqqbzxnauv.supabase.co:6543/postgres
            SUPABASE_URL=https://gfhthbmbgoxqqbzxnauv.supabase.co
            SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmaHRoYm1iZ294cXFienhuYXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzExMjQsImV4cCI6MjA3NTA0NzEyNH0.7cFIaTcDupirdhkHlMgcm7eEUfRMwroVGn1QH4wqwz4
            SUPABASE_SERVICE_ROLE=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmaHRoYm1iZ294cXFienhuYXV2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTQ3MTEyNCwiZXhwIjoyMDc1MDQ3MTI0fQ.p8eR4a95OzlYk_fDmVQ4sPUdaxsZ26iV38qOJTPQ60c
            ENV

            # Export environment variables
            export $(cat production.env | xargs)

            # Stop existing processes
            killall -9 uvicorn 2>/dev/null || true

            # Start backend server
            nohup uvicorn main:app --host 0.0.0.0 --port 8080 --workers 2 > /tmp/rpp_auto.log 2>&1 &

            # Setup .htaccess for API routing
            cd /kunden/homepages/39/d4299589649/htdocs
            cat > .htaccess << 'HTA'
            RewriteEngine On
            RewriteRule ^api/(.*)$ http://localhost:8080/$1 [P,L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^.*$ /index.html [L]
            HTA

            echo ""
            echo "âœ…âœ…âœ… DEPLOYMENT COMPLETE! âœ…âœ…âœ…"
            echo "ðŸŒ http://recessionproofproducts.com"
            echo "ðŸ“± Deployed from GitHub Actions"
            echo "â° $(date)"
